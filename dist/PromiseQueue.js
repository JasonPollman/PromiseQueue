(function(a,b){if('function'==typeof define&&define.amd)define(['module'],b);else if('undefined'!=typeof exports)b(module);else{var c={exports:{}};b(c),a.PromiseQueue=c.exports}})(this,function(a){'use strict';function b(a,b){if(!(a instanceof b))throw new TypeError('Cannot call a class as a function')}function c(a){if(Array.isArray(a)){for(var b=0,c=Array(a.length);b<a.length;b++)c[b]=a[b];return c}return Array.from(a)}function d(a,b){var c=-1;return a.some(function(d,e){return!!b(d,e,a)&&(c=e,!0)}),c}function e(a,b){var c={};return b.forEach(function(b){c[b]=a[b]}),c}function f(a,b,c){return''+b+p(a)+p(c)}function g(a){return l({},e(a,n),{resolve:r(a.resolvers),reject:r(a.rejectors)})}function h(a){return function(b,d,f,g){var h=g[f-1]||null,i=!1,j=!1,k=h&&e(h,n),l=e(d,n);if(a(k,l,function combine(){if(!h)throw new Error('Cannot combine queued method calls without a previous value.');j=!0},function drop(){return i=!0,{resolve:r(d.resolvers),reject:r(d.rejectors)}}),j&&i)throw new Error('Cannot both combine and drop an enqueued method call.');if(j){var m,o;(m=h.resolvers).push.apply(m,c(d.resolvers)),(o=h.rejectors).push.apply(o,c(d.rejectors))}else i||b.push(d);return b}}function i(a,b){var c=2<arguments.length&&arguments[2]!==void 0?arguments[2]:{};if(a&&!(-1<o.indexOf(a))){var d=c;Object.getOwnPropertyNames(a).forEach(function(c){if(!d[c]){d[c]=!0;var e=a[c];'function'!=typeof e||'constructor'===c||b(e,c)}}),Object.getOwnPropertyNames(a.constructor).forEach(function(c){if(!d[c]){d[c]=!0;var e=a.constructor[c];'function'!=typeof e||'prototype'===c||b(e,c)}}),i(Object.getPrototypeOf(a),b,d)}}var j='function'==typeof Symbol&&'symbol'==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&'function'==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?'symbol':typeof a},k=function(){function a(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,'value'in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),l=Object.assign||function(a){for(var b,c=1;c<arguments.length;c++)for(var d in b=arguments[c],b)Object.prototype.hasOwnProperty.call(b,d)&&(a[d]=b[d]);return a},m='__IS_PROMISE_QUEUE_PROMISE__',n=['args','method','priority','context'],o=[Object.prototype,Array.prototype,String.prototype,Number.prototype,Boolean.prototype,Function.prototype],p=function(a){return a.charAt(0).toUpperCase()+a.slice(1)},q=function(a,b){return a.forEach(function(a){return a.apply(void 0,c(b))})},r=function(a){return function(){for(var b=arguments.length,c=Array(b),d=0;d<b;d++)c[d]=arguments[d];return q(a,c)}},s=function(c){return function(d,a){var b=+a.priority-+d.priority;return 0<b&&-1===c.indexOf(d)&&c.push(d),b}},t=function(c){return function(d,a){var b=+d.priority-+a.priority;return 0>b&&-1===c.indexOf(d)&&c.push(d),b}};a.exports=function(){function a(){var c=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},d=c.lifo,e=c.onQueueDrained,f=c.onMethodEnqueued,g=c.maxConcurrency,h=void 0===g?1:g,i=c.handleQueueReduction,j=c.onMethodDeprioritized;b(this,a),this.queue=[],this.running=0,this.lifo=!!(void 0!==d&&d),this.isDrained=!1,this.isPaused=!1,this.handleQueueReduction=i,this.onMethodDeprioritized=j,this.onQueueDrained=e,this.onMethodEnqueued=f,this.setMaxConcurrency(h),this.prioritySortMode=!1}return k(a,null,[{key:'queueify',value:function(b){var c=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},d=c.queue,e=void 0===d?new a:d,f=c.context,g=void 0===f?e:f,h=c.priority,i=void 0===h?0:h;if('function'!=typeof b)throw new TypeError('You must pass a function for parameter "method" to queueify.');if(!(e instanceof a))throw new TypeError('PromiseQueue.queueify expected an instance of PromiseQueue for parameter "queue".');return function(){for(var a=arguments.length,c=Array(a),d=0;d<a;d++)c[d]=arguments[d];return e.enqueue(b,{args:c,context:g,priority:i})}}},{key:'queueifyAll',value:function(b){var c=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},d=c.prefix,e=void 0===d?'queued':d,g=c.suffix,h=void 0===g?'':g,k=c.priorities,l=void 0===k?{}:k,m=c.queue,n=void 0===m?new a:m,o=c.assignQueueAsProperty,p=void 0===o?'queue':o;if('object'!==('undefined'==typeof b?'undefined':j(b))||!Object.isExtensible(b))throw new Error('Cannot queueify a non-object or non-extensible object.');var q=b,r=[];return i(q,function(a,b){return r.push({value:a,property:b})}),r.forEach(function(b){var c=b.value,d=b.property;q[f(d,e,h)]=a.queueify(c,{queue:n,context:q,priority:+l[d]||0})}),'string'==typeof p&&(q[p]=n),b}}]),k(a,[{key:'setMaxConcurrency',value:function(a){return this.maxConcurrency=Math.max(+a||1,1),this}},{key:'onMethodStarted',value:function(){this.running++}},{key:'onMethodCompleted',value:function(a,b){this.running--,q(a,[b]),this.tick()}},{key:'tick',value:function(){var a=this;if(!this.queue.length)return'function'!=typeof this.onQueueDrained||this.isDrained||this.onQueueDrained(),this.isDrained=!0,void(this.prioritySortMode=!1);if(!(this.running>=this.maxConcurrency||this.isPaused)){this.onMethodStarted();var b=this.queue[this.lifo?'pop':'shift'](),d=b.args,e=b.method,f=b.context,g=b.resolvers,h=b.rejectors,i=void 0;try{if(i=e.call.apply(e,[f].concat(c(d))),i&&i[m])throw new Error('Queue out of order execution: cannot resolve with something that won\'t be called until this function completes.')}catch(a){return void this.onMethodCompleted(h,a)}Promise.resolve(i).catch(function(b){return a.onMethodCompleted(h,b)}).then(function(b){return a.onMethodCompleted(g,b)})}}},{key:'prioritizeQueue',value:function(){var a=this,b=[],c=this.lifo?t:s;this.queue.sort(c(b)),'function'==typeof this.onMethodDeprioritized&&b.forEach(function(b){var c=+a.onMethodDeprioritized(e(b,n))||0;b.priority=c})}},{key:'reduceQueue',value:function(){'function'!=typeof this.handleQueueReduction||(this.queue=this.queue.reduce(h(this.handleQueueReduction),[]))}},{key:'enqueue',value:function(a){var b=this,c=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},d=new Promise(function(d,e){var f=c.args,g=void 0===f?[]:f,h=c.priority,i=void 0===h?0:h,j=c.context,k=void 0===j?b:j;return'function'==typeof a?g instanceof Array?(b.queue.push({args:g,method:a,context:k,priority:+i||0,rejectors:[e],resolvers:[d]}),b.isDrained=!1,0!==+i&&(b.prioritySortMode=!0),b.prioritySortMode&&b.prioritizeQueue(),b.reduceQueue(),'function'==typeof b.onMethodEnqueued&&b.onMethodEnqueued(a,c),void Promise.resolve().then(function(){return b.tick()})):e(new TypeError('PromiseQueue#enqueue expected an array for argument "options.args".')):e(new TypeError('PromiseQueue#enqueue expected a function for argument "method".'))});return d[m]=!0,d}},{key:'getEnqueuedMethods',value:function(){return this.queue.map(function(a){var b=a.method;return b})}},{key:'clear',value:function(){var a=this.queue.map(g);return this.queue=[],a}},{key:'remove',value:function(a){if('function'!=typeof a)return null;var b=d(this.queue,function(b){var c=b.method;return c===a});return-1===b?null:g(this.queue.splice(b,1)[0])}},{key:'pause',value:function(){return this.isPaused=!0,this}},{key:'resume',value:function(){return this.isPaused&&(this.isPaused=!1,this.tick()),this}},{key:'size',get:function(){return this.queue.length}},{key:'push',get:function(){return this.enqueue}}]),a}()});
//# sourceMappingURL=PromiseQueue.js.map