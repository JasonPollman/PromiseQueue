(function(a,b){if('function'==typeof define&&define.amd)define(['module'],b);else if('undefined'!=typeof exports)b(module);else{var c={exports:{}};b(c),a.PromiseQueue=c.exports}})(this,function(a){'use strict';function b(a,b){if(!(a instanceof b))throw new TypeError('Cannot call a class as a function')}function c(a){if(Array.isArray(a)){for(var b=0,c=Array(a.length);b<a.length;b++)c[b]=a[b];return c}return Array.from(a)}function d(a,b){var c=-1;return a.some(function(d,e){return!!b(d,e,a)&&(c=e,!0)}),c}function e(a,b){var c={};return b.forEach(function(b){c[b]=a[b]}),c}function f(a,b,c){return''+b+o(a)+o(c)}function g(a){return Object.assign(e(a,m),{resolve:function(){for(var b=arguments.length,c=Array(b),d=0;d<b;d++)c[d]=arguments[d];return q(a.resolvers,c)},reject:function(){for(var b=arguments.length,c=Array(b),d=0;d<b;d++)c[d]=arguments[d];return q(a.rejectors,c)}})}function h(a){return function(b,d,f,g){var h=g[f-1]||null,i=!1,j=!1,k=h&&e(h,m),l=e(d,m);if(a(k,l,function combine(){if(!h)throw new Error('Cannot combine queued method calls without a previous value.');j=!0},function drop(){return i=!0,{resolve:function(){for(var a=arguments.length,b=Array(a),c=0;c<a;c++)b[c]=arguments[c];return q(d.resolvers,b)},reject:function(){for(var a=arguments.length,b=Array(a),c=0;c<a;c++)b[c]=arguments[c];return q(d.rejectors,b)}}}),j&&i)throw new Error('Cannot both combine and drop an enqueued method call.');if(j){var n,o;(n=h.resolvers).push.apply(n,c(d.resolvers)),(o=h.rejectors).push.apply(o,c(d.rejectors))}else i||b.push(d);return b}}function i(a,b){var c=2<arguments.length&&arguments[2]!==void 0?arguments[2]:{};if(a&&!(-1<n.indexOf(a))){var d=c;Object.getOwnPropertyNames(a).forEach(function(c){if(!d[c]){d[c]=!0;var e=a[c];'function'!=typeof e||'constructor'===c||b(e,c)}}),Object.getOwnPropertyNames(a.constructor).forEach(function(c){if(!d[c]){d[c]=!0;var e=a.constructor[c];'function'!=typeof e||'prototype'===c||b(e,c)}}),i(Object.getPrototypeOf(a),b,d)}}var j='function'==typeof Symbol&&'symbol'==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&'function'==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?'symbol':typeof a},k=function(){function a(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,'value'in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),l=0,m=['args','method','priority','context'],n=[Object.prototype,Array.prototype,String.prototype,Number.prototype,Boolean.prototype,Function.prototype],o=function(a){return a.charAt(0).toUpperCase()+a.slice(1)},p=function(c,a){return+a.priority-+c.priority},q=function(a,b){return a.forEach(function(a){return a.apply(void 0,c(b))})};a.exports=function(){function a(){var c=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},d=c.lifo,e=c.maxConcurrency,f=void 0===e?1:e,g=c.handleQueueReduction,h=c.onQueueDrained;b(this,a),this.id=l++,this.queue=[],this.running=0,this.isDrained=!1,this.lifo=!!(void 0!==d&&d),this.isPaused=!1,this.handleQueueReduction=g,this.onQueueDrained=h,this.setMaxConcurrency(f)}return k(a,null,[{key:'queueify',value:function(b){var c=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},d=c.queue,e=void 0===d?new a:d,f=c.context,g=void 0===f?e:f,h=c.priority,i=void 0===h?0:h;if('function'!=typeof b)throw new TypeError('You must pass a function for parameter "method" to queueify.');if(!(e instanceof a))throw new TypeError('PromiseQueue.queueify expected an instance of PromiseQueue for parameter "queue".');return function(){for(var a=arguments.length,c=Array(a),d=0;d<a;d++)c[d]=arguments[d];return e.enqueue(b,{args:c,context:g,priority:i})}}},{key:'queueifyAll',value:function(b){var c=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},d=c.prefix,e=void 0===d?'queued':d,g=c.suffix,h=void 0===g?'':g,k=c.priorities,l=void 0===k?{}:k,m=c.queue,n=void 0===m?new a:m,o=c.assignQueueAsProperty,p=void 0===o?'queue':o;if('object'!==('undefined'==typeof b?'undefined':j(b))||!Object.isExtensible(b))throw new Error('Cannot queueify a non-object or non-extensible object.');var q=b,r=[];return i(q,function(a,b){return r.push({value:a,property:b})}),r.forEach(function(b){var c=b.value,d=b.property;q[f(d,e,h)]=a.queueify(c,{queue:n,context:q,priority:+l[d]||0})}),'string'==typeof p&&(q[p]=n),b}}]),k(a,[{key:'keyForEnqueuedPromise',value:function(){return'__ENQUEUED_EXECUTION_PROMISE_'+this.id+'__'}},{key:'setMaxConcurrency',value:function(a){return this.maxConcurrency=Math.max(+a||1,1),this}},{key:'onMethodStarted',value:function(){this.running++}},{key:'onMethodCompleted',value:function(a,b){this.running--,q(a,[b]),this.tick()}},{key:'tick',value:function(){var a=this;if(!this.queue.length)return'function'!=typeof this.onQueueDrained||this.isDrained||this.onQueueDrained(),void(this.isDrained=!0);if(!(this.running>=this.maxConcurrency||this.isPaused)){this.onMethodStarted();var b=this.queue[this.lifo?'pop':'shift'](),d=b.args,e=b.method,f=b.context,g=b.resolvers,h=b.rejectors,i=void 0;try{if(i=e.call.apply(e,[f].concat(c(d))),i&&i[this.keyForEnqueuedPromise()])throw new Error('Queue out of order execution: cannot resolve with something that won\'t be called until this function completes.')}catch(a){return void this.onMethodCompleted(h,a)}Promise.resolve(i).catch(function(b){return a.onMethodCompleted(h,b)}).then(function(b){return a.onMethodCompleted(g,b)})}}},{key:'priortizeQueue',value:function(){this.queue.sort(p)}},{key:'reduceQueue',value:function(){'function'!=typeof this.handleQueueReduction||(this.queue=this.queue.reduce(h(this.handleQueueReduction),[]))}},{key:'enqueue',value:function(a){var b=this,c=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},d=c.args,e=void 0===d?[]:d,f=c.priority,g=void 0===f?0:f,h=c.context,i=void 0===h?this:h,j=new Promise(function(c,d){return'function'==typeof a?e instanceof Array?(b.queue.push({args:e,method:a,context:i,priority:+g||0,rejectors:[d],resolvers:[c]}),b.isDrained=!1,b.priortizeQueue(),b.reduceQueue(),void Promise.resolve().then(function(){return b.tick()})):d(new TypeError('PromiseQueue#enqueue expected an array for argument "options.args".')):d(new TypeError('PromiseQueue#enqueue expected a function for argument "method".'))});return j[this.keyForEnqueuedPromise()]=!0,j}},{key:'getEnqueuedMethods',value:function(){return this.queue.map(function(a){var b=a.method;return b})}},{key:'clear',value:function(){var a=this.queue.map(g);return this.queue=[],a}},{key:'remove',value:function(a){if('function'!=typeof a)return null;var b=d(this.queue,function(b){var c=b.method;return c===a});return-1===b?null:g(this.queue.splice(b,1)[0])}},{key:'pause',value:function(){return this.isPaused=!0,this}},{key:'resume',value:function(){return this.isPaused&&(this.isPaused=!1,this.tick()),this}},{key:'size',get:function(){return this.queue.length}},{key:'push',get:function(){return this.enqueue}}]),a}()});
//# sourceMappingURL=PromiseQueue.js.map